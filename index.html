<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai Joo - منصة الذكاء الاصطناعي المتكاملة</title>
    
     Meta Tags 
    <meta name="description" content="منصة الذكاء الاصطناعي المتقدمة مع مكالمات صوتية ورفع ملفات">
    <meta name="keywords" content="ذكاء اصطناعي, شات بوت, مكالمات صوتية">
    <meta name="author" content="المهندس يوسف خالد">
    
     External Libraries 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
     Firebase 
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #10a37f;
            --primary-hover: #0d8f6f;
            --primary-light: rgba(16, 163, 127, 0.1);
            --secondary: #6366f1;
            --secondary-hover: #5855eb;
            --accent: #f59e0b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #0f0f0f;
            --dark-surface: #1a1a1a;
            --dark-elevated: #2d2d2d;
            --dark-border: #404040;
            --light: #ffffff;
            --light-surface: #f8fafc;
            --light-elevated: #f1f5f9;
            --light-border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --text-inverse: #ffffff;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            --gradient-surface: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Cairo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }

        body.dark-theme {
            background: var(--dark);
            color: var(--text-inverse);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 3px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .dark-theme ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
            background: var(--light);
            transition: var(--transition);
        }

        .dark-theme .app-container {
            background: var(--dark);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--light-surface);
            border-right: 1px solid var(--light-border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            position: relative;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .dark-theme .sidebar {
            background: var(--dark-surface);
            border-right-color: var(--dark-border);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-border);
            background: var(--light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dark-theme .sidebar-header {
            background: var(--dark);
            border-bottom-color: var(--dark-border);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            border-radius: var(--border-radius-lg);
            background: var(--gradient-primary);
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }

        .app-logo:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .app-logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .app-logo-text {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .new-chat-btn:hover::before {
            left: 100%;
        }

        .new-chat-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .new-chat-btn:active {
            transform: translateY(0);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-history-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 12px 8px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 2px;
            position: relative;
            group: hover;
        }

        .chat-item:hover {
            background: var(--light-elevated);
            transform: translateX(-2px);
        }

        .dark-theme .chat-item:hover {
            background: var(--dark-elevated);
        }

        .chat-item.active {
            background: var(--primary-light);
            border-left: 3px solid var(--primary);
        }

        .chat-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .dark-theme .chat-item-title {
            color: var(--text-inverse);
        }

        .chat-item-preview {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chat-item-actions {
            display: none;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: var(--transition);
        }

        .chat-item:hover .chat-item-actions {
            display: flex;
            opacity: 1;
        }

        .chat-action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
            font-size: 12px;
        }

        .chat-action-btn:hover {
            background: var(--light-border);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .dark-theme .chat-action-btn:hover {
            background: var(--dark-border);
            color: var(--text-inverse);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--light-border);
            background: var(--light);
        }

        .dark-theme .sidebar-footer {
            background: var(--dark);
            border-top-color: var(--dark-border);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .user-profile:hover {
            background: var(--light-elevated);
        }

        .dark-theme .user-profile:hover {
            background: var(--dark-elevated);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--success);
            border: 2px solid var(--light);
            border-radius: 50%;
        }

        .dark-theme .user-status {
            border-color: var(--dark);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dark-theme .user-name {
            color: var(--text-inverse);
        }

        .user-email {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-menu-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
        }

        .user-menu-btn:hover {
            background: var(--light-border);
            color: var(--text-primary);
        }

        .dark-theme .user-menu-btn:hover {
            background: var(--dark-border);
            color: var(--text-inverse);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--light);
            position: relative;
            min-width: 0;
        }

        .dark-theme .main-content {
            background: var(--dark);
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--light-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--light);
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(20px);
        }

        .dark-theme .chat-header {
            background: var(--dark);
            border-bottom-color: var(--dark-border);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sidebar-toggle {
            display: none;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 18px;
        }

        .sidebar-toggle:hover {
            background: var(--light-elevated);
            color: var(--text-primary);
        }

        .dark-theme .sidebar-toggle:hover {
            background: var(--dark-elevated);
            color: var(--text-inverse);
        }

        .chat-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .dark-theme .chat-title {
            color: var(--text-inverse);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 16px;
            position: relative;
        }

        .action-btn:hover {
            background: var(--light-elevated);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .dark-theme .action-btn:hover {
            background: var(--dark-elevated);
            color: var(--text-inverse);
        }

        .action-btn.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 100%;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
            margin-left: auto;
            max-width: 85%;
        }

        .message.assistant {
            max-width: 100%;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--light-elevated);
            color: var(--primary);
            border: 2px solid var(--light-border);
        }

        .dark-theme .message.assistant .message-avatar {
            background: var(--dark-elevated);
            border-color: var(--dark-border);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: var(--border-radius-lg);
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            transition: var(--transition);
        }

        .message.user .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: var(--shadow-md);
        }

        .message.assistant .message-bubble {
            background: var(--light-surface);
            color: var(--text-primary);
            border: 1px solid var(--light-border);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-sm);
        }

        .dark-theme .message.assistant .message-bubble {
            background: var(--dark-surface);
            border-color: var(--dark-border);
            color: var(--text-inverse);
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: right;
        }

        .message.user .message-time {
            text-align: left;
        }

        .message-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            opacity: 0;
            transition: var(--transition);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-elevated);
            border: 1px solid var(--light-border);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            font-size: 13px;
        }

        .message-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
            transform: scale(1.05);
        }

        .dark-theme .message-action-btn {
            background: var(--dark-elevated);
            border-color: var(--dark-border);
        }

        .dark-theme .message-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 48px 24px;
            max-width: 900px;
            margin: 0 auto;
        }

        .welcome-logo {
            width: 100px;
            height: 100px;
            background: var(--gradient-primary);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            margin-bottom: 32px;
            animation: logoFloat 4s ease-in-out infinite;
            box-shadow: var(--shadow-xl);
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(1deg); }
            50% { transform: translateY(-10px) rotate(0deg); }
            75% { transform: translateY(-5px) rotate(-1deg); }
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .dark-theme .welcome-title {
            color: var(--text-inverse);
        }

        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            max-width: 600px;
            line-height: 1.6;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 32px;
        }

        .feature-card {
            padding: 24px;
            background: var(--light-surface);
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: var(--transition);
            text-align: right;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 163, 127, 0.1), transparent);
            transition: var(--transition);
        }

        .feature-card:hover::before {
            left: 100%;
        }

        .feature-card:hover {
            background: var(--light);
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .dark-theme .feature-card {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .dark-theme .feature-card:hover {
            background: var(--dark-elevated);
            border-color: var(--primary);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-bottom: 16px;
            margin-right: auto;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dark-theme .feature-title {
            color: var(--text-inverse);
        }

        .feature-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .quick-action-btn {
            padding: 12px 24px;
            background: var(--light-elevated);
            border: 1px solid var(--light-border);
            color: var(--text-primary);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .dark-theme .quick-action-btn {
            background: var(--dark-elevated);
            border-color: var(--dark-border);
            color: var(--text-inverse);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
            padding: 16px 20px;
            background: var(--light-surface);
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius-lg);
            border-bottom-left-radius: 6px;
        }

        .dark-theme .typing-dots {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 80%, 100% { 
                transform: scale(0.8); 
                opacity: 0.5; 
            }
            40% { 
                transform: scale(1.2); 
                opacity: 1; 
            }
        }

        /* Chat Input */
        .chat-input-container {
            padding: 24px;
            background: var(--light);
            border-top: 1px solid var(--light-border);
            position: relative;
        }

        .dark-theme .chat-input-container {
            background: var(--dark);
            border-top-color: var(--dark-border);
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .file-upload-area {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--light-surface);
            border: 2px dashed var(--light-border);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            text-align: center;
            display: none;
            transition: var(--transition);
            margin-bottom: 12px;
            backdrop-filter: blur(20px);
        }

        .file-upload-area.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .dark-theme .file-upload-area {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .file-upload-icon {
            font-size: 36px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .file-upload-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dark-theme .file-upload-text {
            color: var(--text-inverse);
        }

        .file-upload-hint {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .uploaded-files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .file-remove-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.8;
            transition: var(--transition);
            padding: 2px;
            border-radius: 2px;
        }

        .file-remove-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            padding: 16px 20px;
            background: var(--light-surface);
            border: 2px solid var(--light-border);
            border-radius: var(--border-radius-xl);
            transition: var(--transition);
            position: relative;
            backdrop-filter: blur(20px);
        }

        .input-container:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .dark-theme .input-container {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 16px;
            position: relative;
        }

        .input-action-btn:hover {
            background: var(--light-border);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .dark-theme .input-action-btn:hover {
            background: var(--dark-border);
            color: var(--text-inverse);
        }

        .input-action-btn.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .input-action-btn.recording {
            background: var(--danger);
            color: white;
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            max-height: 200px;
            min-height: 24px;
            font-family: inherit;
            font-weight: 400;
        }

        .dark-theme .chat-input {
            color: var(--text-inverse);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: var(--transition);
        }

        .send-btn:hover::before {
            left: 100%;
        }

        .send-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Voice Call Interface */
        .voice-call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .voice-call-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .voice-call-container {
            background: var(--light);
            border-radius: var(--border-radius-xl);
            padding: 48px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-2xl);
        }

        .dark-theme .voice-call-container {
            background: var(--dark-surface);
        }

        .call-avatar {
            width: 120px;
            height: 120px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            margin: 0 auto 24px;
            animation: callPulse 2s infinite;
        }

        @keyframes callPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .call-status {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .dark-theme .call-status {
            color: var(--text-inverse);
        }

        .call-duration {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .call-control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-control-btn.mute {
            background: var(--light-elevated);
            color: var(--text-primary);
        }

        .call-control-btn.mute.active {
            background: var(--warning);
            color: white;
        }

        .call-control-btn.end {
            background: var(--danger);
            color: white;
        }

        .call-control-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(20px);
        }

        .login-card {
            background: var(--light);
            border-radius: var(--border-radius-xl);
            padding: 48px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .dark-theme .login-card {
            background: var(--dark-surface);
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            margin: 0 auto 32px;
            box-shadow: var(--shadow-lg);
        }

        .login-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .dark-theme .login-title {
            color: var(--text-inverse);
        }

        .login-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 16px 24px;
            background: white;
            border: 2px solid var(--light-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .google-login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.05), transparent);
            transition: var(--transition);
        }

        .google-login-btn:hover::before {
            left: 100%;
        }

        .google-login-btn:hover {
            background: var(--light-surface);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .google-icon {
            width: 24px;
            height: 24px;
        }

        .skip-login-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            transition: var(--transition);
            padding: 8px;
            border-radius: 4px;
        }

        .skip-login-btn:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--light);
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius-lg);
            padding: 16px 20px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            min-width: 300px;
            transform: translateX(450px);
            transition: var(--transition);
            z-index: 3000;
            backdrop-filter: blur(20px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .dark-theme .notification {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification.info {
            border-left: 4px solid var(--info);
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification.success .notification-icon {
            color: var(--success);
        }

        .notification.error .notification-icon {
            color: var(--danger);
        }

        .notification.warning .notification-icon {
            color: var(--warning);
        }

        .notification.info .notification-icon {
            color: var(--info);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .dark-theme .notification-title {
            color: var(--text-inverse);
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: var(--light-elevated);
            color: var(--text-primary);
        }

        .dark-theme .notification-close:hover {
            background: var(--dark-elevated);
            color: var(--text-inverse);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            margin-top: 16px;
            text-align: center;
        }

        /* Code Highlighting */
        .code-block {
            background: var(--dark);
            border-radius: var(--border-radius);
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            position: relative;
            border: 1px solid var(--dark-border);
        }

        .code-block pre {
            margin: 0;
            color: #e5e7eb;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .copy-code-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .copy-code-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* User Menu Dropdown */
        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--light);
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 8px;
            min-width: 200px;
            display: none;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .user-menu.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dark-theme .user-menu {
            background: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            color: var(--text-primary);
        }

        .menu-item:hover {
            background: var(--light-elevated);
        }

        .dark-theme .menu-item {
            color: var(--text-inverse);
        }

        .dark-theme .menu-item:hover {
            background: var(--dark-elevated);
        }

        .menu-item-icon {
            width: 16px;
            text-align: center;
            color: var(--text-secondary);
        }

        .menu-divider {
            height: 1px;
            background: var(--light-border);
            margin: 8px 0;
        }

        .dark-theme .menu-divider {
            background: var(--dark-border);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }
            
            .welcome-features {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                height: 100vh;
                z-index: 200;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: var(--shadow-2xl);
            }

            .sidebar.open {
                transform: translateX(280px);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-content {
                width: 100%;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .chat-title {
                font-size: 18px;
            }

            .chat-messages {
                padding: 16px;
                gap: 16px;
            }

            .message {
                gap: 12px;
            }

            .message.user {
                max-width: 90%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .message-bubble {
                padding: 12px 16px;
                font-size: 14px;
            }

            .chat-input-container {
                padding: 16px;
            }

            .input-container {
                padding: 12px 16px;
            }

            .input-action-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .welcome-screen {
                padding: 32px 16px;
            }

            .welcome-logo {
                width: 80px;
                height: 80px;
                font-size: 32px;
            }

            .welcome-title {
                font-size: 28px;
            }

            .welcome-subtitle {
                font-size: 16px;
            }

            .welcome-features {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .feature-card {
                padding: 20px;
            }

            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }

            .notification {
                top: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
                transform: translateY(-100px);
            }

            .notification.show {
                transform: translateY(0);
            }

            .voice-call-container {
                padding: 32px 24px;
                margin: 16px;
            }

            .call-avatar {
                width: 100px;
                height: 100px;
                font-size: 40px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 100%;
                left: -100%;
            }

            .sidebar.open {
                transform: translateX(100%);
            }

            .chat-header {
                padding: 8px 12px;
            }

            .chat-title {
                font-size: 16px;
            }

            .action-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .chat-messages {
                padding: 12px;
            }

            .message-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .message-bubble {
                padding: 10px 14px;
                font-size: 13px;
            }

            .input-container {
                padding: 10px 12px;
            }

            .input-action-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }

            .welcome-logo {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .welcome-title {
                font-size: 24px;
            }

            .welcome-subtitle {
                font-size: 14px;
            }

            .feature-card {
                padding: 16px;
            }

            .feature-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .feature-title {
                font-size: 16px;
            }

            .feature-description {
                font-size: 13px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Dark theme toggle animation */
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Focus styles for accessibility */
        .focus-visible:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --light-border: #000000;
                --dark-border: #ffffff;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .chat-header,
            .chat-input-container,
            .notification,
            .loading-overlay,
            .login-modal,
            .voice-call-overlay {
                display: none !important;
            }

            .main-content {
                width: 100% !important;
            }

            .chat-messages {
                padding: 0 !important;
            }

            .message-bubble {
                border: 1px solid #ccc !important;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body class="theme-transition">
     Loading Overlay 
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">جاري التحميل...</div>
        </div>
    </div>

     Login Modal 
    <div class="login-modal" id="loginModal">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-brain"></i>
            </div>
            <h2 class="login-title">مرحباً بك في <span style="color: var(--primary);">Ai</span> <span style="color: var(--secondary);">Joo</span></h2>
            <p class="login-subtitle">سجل دخولك للاستمتاع بجميع المميزات المتقدمة والمكالمات الصوتية</p>
            
            <button class="google-login-btn" onclick="signInWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                تسجيل الدخول بـ Google
            </button>
            
            <button class="skip-login-btn" onclick="skipLogin()">
                المتابعة كضيف
            </button>
        </div>
    </div>

     Voice Call Overlay 
    <div class="voice-call-overlay" id="voiceCallOverlay">
        <div class="voice-call-container">
            <div class="call-avatar">
                <i class="fas fa-brain"></i>
            </div>
            <div class="call-status" id="callStatus">مكالمة صوتية مع Ai Joo</div>
            <div class="call-duration" id="callDuration">00:00</div>
            <div class="call-controls">
                <button class="call-control-btn mute" id="muteBtn" onclick="toggleMute()">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-control-btn end" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

     Main App Container 
    <div class="app-container">
         Sidebar 
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="app-logo">
                    <div class="app-logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="app-logo-text">Ai Joo</div>
                </a>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i>
                    محادثة جديدة
                </button>
            </div>

            <div class="sidebar-content">
                <div class="chat-history-section">
                    <div class="section-title">المحادثات الأخيرة</div>
                    <div class="chat-history" id="chatHistory">
                         Chat history will be populated here 
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                        <div class="user-status"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">مستخدم ضيف</div>
                        <div class="user-email" id="userEmail">guest@aijoo.com</div>
                    </div>
                    <button class="user-menu-btn">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                
                 User Menu Dropdown 
                <div class="user-menu" id="userMenu">
                    <div class="menu-item" onclick="showProfile()">
                        <div class="menu-item-icon"><i class="fas fa-user"></i></div>
                        الملف الشخصي
                    </div>
                    <div class="menu-item" onclick="showSettings()">
                        <div class="menu-item-icon"><i class="fas fa-cog"></i></div>
                        الإعدادات
                    </div>
                    <div class="menu-item" onclick="toggleTheme()">
                        <div class="menu-item-icon"><i class="fas fa-moon" id="themeMenuIcon"></i></div>
                        <span id="themeMenuText">الوضع المظلم</span>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item" onclick="signOut()">
                        <div class="menu-item-icon"><i class="fas fa-sign-out-alt"></i></div>
                        تسجيل الخروج
                    </div>
                </div>
            </div>
        </div>

         Main Content 
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="chat-title" id="chatTitle">Ai Joo</h1>
                        <div class="chat-status">
                            <div class="status-indicator"></div>
                            <span>متصل ونشط</span>
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn" onclick="startVoiceCall()" title="مكالمة صوتية" id="voiceCallBtn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="action-btn" onclick="toggleTheme()" title="تبديل المظهر">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="action-btn" onclick="exportChat()" title="تصدير المحادثة">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" onclick="clearCurrentChat()" title="مسح المحادثة">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="action-btn" onclick="showSettings()" title="الإعدادات">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-screen">
                    <div class="welcome-logo bounce-in">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h2 class="welcome-title">مرحباً بك في <span style="color: var(--primary);">Ai</span> <span style="color: var(--secondary);">Joo</span></h2>
                    <p class="welcome-subtitle">منصة الذكاء الاصطناعي المتكاملة مع مكالمات صوتية ورفع ملفات ومميزات متقدمة. ابدأ محادثتك الآن!</p>
                    
                    <div class="welcome-features">
                        <div class="feature-card" onclick="sendSuggestion('اشرح لي مفهوم الذكاء الاصطناعي والتعلم الآلي بطريقة مبسطة')">
                            <div class="feature-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="feature-title">الذكاء الاصطناعي</div>
                            <div class="feature-description">تعلم واكتشف عالم الذكاء الاصطناعي والتعلم الآلي</div>
                        </div>
                        
                        <div class="feature-card" onclick="sendSuggestion('اكتب لي مقال احترافي عن أهمية التكنولوجيا في التعليم')">
                            <div class="feature-icon">
                                <i class="fas fa-pen-fancy"></i>
                            </div>
                            <div class="feature-title">الكتابة الإبداعية</div>
                            <div class="feature-description">مساعدة في الكتابة والتحرير والإبداع الأدبي</div>
                        </div>
                        
                        <div class="feature-card" onclick="sendSuggestion('ساعدني في حل مسائل رياضية معقدة خطوة بخطوة')">
                            <div class="feature-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="feature-title">حل المسائل</div>
                            <div class="feature-description">مساعدة في الرياضيات والعلوم والمنطق</div>
                        </div>
                        
                        <div class="feature-card" onclick="sendSuggestion('اكتب لي كود برمجي متقدم بلغة Python مع الشرح')">
                            <div class="feature-icon">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="feature-title">البرمجة المتقدمة</div>
                            <div class="feature-description">مساعدة في كتابة وتطوير الكود البرمجي</div>
                        </div>
                        
                        <div class="feature-card" onclick="startVoiceCall()">
                            <div class="feature-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="feature-title">مكالمة صوتية</div>
                            <div class="feature-description">تحدث مع Ai Joo بالصوت مباشرة</div>
                        </div>
                        
                        <div class="feature-card" onclick="toggleFileUpload()">
                            <div class="feature-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="feature-title">رفع الملفات</div>
                            <div class="feature-description">ارفع الصور والمستندات للتحليل</div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="sendSuggestion('ما الجديد في عالم التكنولوجيا؟')">
                            أخبار التكنولوجيا
                        </button>
                        <button class="quick-action-btn" onclick="sendSuggestion('اعطني نصائح لتحسين الإنتاجية')">
                            نصائح الإنتاجية
                        </button>
                        <button class="quick-action-btn" onclick="sendSuggestion('اكتب لي قصة قصيرة مشوقة')">
                            قصة إبداعية
                        </button>
                        <button class="quick-action-btn" onclick="sendSuggestion('ساعدني في تعلم لغة جديدة')">
                            تعلم اللغات
                        </button>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-wrapper">
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="file-upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="file-upload-text">اسحب الملفات هنا أو انقر للاختيار</div>
                        <div class="file-upload-hint">يدعم: الصور، المستندات، ملفات PDF، النصوص (حتى 10MB لكل ملف)</div>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                    </div>
                    
                    <div class="input-container">
                        <div class="input-actions">
                            <button class="input-action-btn" onclick="toggleFileUpload()" title="إرفاق ملف">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn" onclick="toggleVoiceInput()" title="إدخال صوتي" id="voiceInputBtn">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="input-action-btn" onclick="insertEmoji()" title="إضافة رمز تعبيري">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="input-action-btn" onclick="startVoiceCall()" title="مكالمة صوتية">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                        
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="اكتب رسالتك هنا... (اضغط Enter للإرسال، Shift+Enter لسطر جديد)"
                            rows="1"
                        ></textarea>
                        
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

     Notification 
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">نجح</div>
            <div class="notification-message" id="notificationMessage">تمت العملية بنجاح</div>
        </div>
        <button class="notification-close" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

     Hidden File Input 
    <input type="file" id="fileInput" multiple accept="image/*,text/*,.pdf,.doc,.docx,.txt,.csv,.json" style="display: none;">

     External Scripts 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLcgg-3wUVoC-xVhJNsJBVqyCuGN-TpPk",
            authDomain: "aijoo-chat-platform.firebaseapp.com",
            projectId: "aijoo-chat-platform",
            storageBucket: "aijoo-chat-platform.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789012345678",
            databaseURL: "https://aijoo-chat-platform-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        let firebaseInitialized = false;
        let db, auth, storage, realtimeDb;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            realtimeDb = firebase.database();
            firebaseInitialized = true;
            console.log('🔥 Firebase initialized successfully');
        } catch (error) {
            console.warn('⚠️ Firebase initialization failed, using localStorage:', error);
        }

        class AiJooAdvancedChat {
            constructor() {
                this.apiKey = 'AIzaSyBLcgg-3wUVoC-xVhJNsJBVqyCuGN-TpPk';
                this.apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
                this.currentUser = null;
                this.currentChatId = null;
                this.chatHistory = [];
                this.uploadedFiles = [];
                this.isRecording = false;
                this.isInCall = false;
                this.callStartTime = null;
                this.callDuration = 0;
                this.recognition = null;
                this.synthesis = null;
                this.darkTheme = false;
                this.peerConnection = null;
                this.localStream = null;
                this.remoteStream = null;
                
                this.initializeApp();
            }

            async initializeApp() {
                this.showLoading('جاري تحميل المنصة...');
                
                try {
                    this.setupEventListeners();
                    this.initializeSpeechRecognition();
                    this.initializeSpeechSynthesis();
                    this.initializeWebRTC();
                    this.setupFileUpload();
                    this.loadTheme();
                    await this.checkAuthState();
                    await this.loadChatHistory();
                    this.adjustTextareaHeight();
                    this.startPeriodicSave();
                    
                    this.hideLoading();
                    this.showNotification('مرحباً بك', 'تم تحميل Ai Joo بنجاح!', 'success');
                } catch (error) {
                    console.error('Error initializing app:', error);
                    this.hideLoading();
                    this.showNotification('خطأ في التحميل', 'حدث خطأ أثناء تحميل التطبيق', 'error');
                }
            }

            setupEventListeners() {
                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');

                // Send message on Enter
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                chatInput.addEventListener('input', () => {
                    this.adjustTextareaHeight();
                    this.updateTypingStatus();
                });

                // Send button click
                sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-profile') && !e.target.closest('.user-menu')) {
                        document.getElementById('userMenu').classList.remove('show');
                    }
                    
                    if (!e.target.closest('.sidebar') && !e.target.closest('.sidebar-toggle')) {
                        if (window.innerWidth <= 768) {
                            document.getElementById('sidebar').classList.remove('open');
                        }
                    }
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    this.handleResize();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'k':
                                e.preventDefault();
                                chatInput.focus();
                                break;
                            case 'n':
                                e.preventDefault();
                                this.startNewChat();
                                break;
                            case '/':
                                e.preventDefault();
                                this.toggleTheme();
                                break;
                            case 'e':
                                e.preventDefault();
                                this.exportChat();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });

                // Handle online/offline status
                window.addEventListener('online', () => {
                    this.showNotification('متصل', 'تم استعادة الاتصال بالإنترنت', 'success');
                    this.syncOfflineData();
                });

                window.addEventListener('offline', () => {
                    this.showNotification('غير متصل', 'انقطع الاتصال - سيتم العمل في وضع عدم الاتصال', 'warning');
                });

                // Auto-save before page unload
                window.addEventListener('beforeunload', (e) => {
                    this.saveCurrentChat();
                    if (this.isInCall) {
                        e.preventDefault();
                        e.returnValue = 'لديك مكالمة نشطة. هل أنت متأكد من المغادرة؟';
                    }
                });
            }

            adjustTextareaHeight() {
                const textarea = document.getElementById('chatInput');
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 200);
                textarea.style.height = newHeight + 'px';
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'ar-SA';
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;

                    this.recognition.onstart = () => {
                        this.showNotification('بدء التسجيل', 'يتم الآن التسجيل الصوتي...', 'info');
                    };

                    this.recognition.onresult = (event) => {
                        let transcript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            transcript += event.results[i][0].transcript;
                        }
                        
                        const chatInput = document.getElementById('chatInput');
                        if (event.results[event.results.length - 1].isFinal) {
                            chatInput.value += transcript + ' ';
                        }
                        this.adjustTextareaHeight();
                    };

                    this.recognition.onerror = (event) => {
                        this.showNotification('خطأ في التسجيل', `خطأ في التعرف على الصوت: ${event.error}`, 'error');
                        this.stopVoiceInput();
                    };

                    this.recognition.onend = () => {
                        this.stopVoiceInput();
                    };
                }
            }

            initializeSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    this.synthesis = window.speechSynthesis;
                }
            }

            async initializeWebRTC() {
                try {
                    // Initialize WebRTC for voice calls
                    this.peerConnection = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    });

                    this.peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // Send ICE candidate to remote peer
                            console.log('ICE candidate:', event.candidate);
                        }
                    };

                    this.peerConnection.ontrack = (event) => {
                        this.remoteStream = event.streams[0];
                        // Handle remote audio stream
                    };
                } catch (error) {
                    console.warn('WebRTC not supported:', error);
                }
            }

            setupFileUpload() {
                const fileInput = document.getElementById('fileInput');
                const fileUploadArea = document.getElementById('fileUploadArea');

                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });

                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });

                fileUploadArea.addEventListener('dragleave', (e) => {
                    if (!fileUploadArea.contains(e.relatedTarget)) {
                        fileUploadArea.classList.remove('dragover');
                    }
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            async handleFiles(files) {
                const maxFileSize = 10 * 1024 * 1024; // 10MB
                const supportedTypes = ['image/', 'text/', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument'];
                
                for (let file of files) {
                    if (file.size > maxFileSize) {
                        this.showNotification('ملف كبير', `الملف ${file.name} يتجاوز 10MB`, 'warning');
                        continue;
                    }

                    if (!supportedTypes.some(type => file.type.startsWith(type))) {
                        this.showNotification('نوع غير مدعوم', `نوع الملف ${file.type} غير مدعوم`, 'warning');
                        continue;
                    }

                    try {
                        const fileData = await this.processFile(file);
                        const fileObj = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: fileData,
                            uploadedAt: new Date().toISOString()
                        };

                        this.uploadedFiles.push(fileObj);
                        this.displayUploadedFile(fileObj);
                        
                        // Upload to Firebase Storage if available
                        if (firebaseInitialized && this.currentUser) {
                            await this.uploadFileToStorage(file, fileObj.id);
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        this.showNotification('خطأ في الملف', `فشل في معالجة الملف ${file.name}`, 'error');
                    }
                }

                if (files.length > 0) {
                    this.showNotification('تم الرفع', `تم رفع ${files.length} ملف بنجاح`, 'success');
                }
            }

            async processFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('فشل في قراءة الملف'));
                    };

                    if (file.type.startsWith('image/')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            }

            async uploadFileToStorage(file, fileId) {
                try {
                    const storageRef = storage.ref(`files/${this.currentUser.uid}/${fileId}`);
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    return downloadURL;
                } catch (error) {
                    console.error('Error uploading to Firebase Storage:', error);
                    throw error;
                }
            }

            displayUploadedFile(fileObj) {
                const uploadedFiles = document.getElementById('uploadedFiles');
                const fileElement = document.createElement('div');
                fileElement.className = 'uploaded-file fade-in';
                fileElement.innerHTML = `
                    <i class="fas fa-${this.getFileIcon(fileObj.type)}"></i>
                    <span>${fileObj.name}</span>
                    <button class="file-remove-btn" onclick="aiJooChat.removeFile('${fileObj.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                uploadedFiles.appendChild(fileElement);
            }

            getFileIcon(fileType) {
                if (fileType.startsWith('image/')) return 'image';
                if (fileType.startsWith('text/')) return 'file-alt';
                if (fileType.includes('pdf')) return 'file-pdf';
                if (fileType.includes('word')) return 'file-word';
                if (fileType.includes('excel')) return 'file-excel';
                return 'file';
            }

            removeFile(fileId) {
                this.uploadedFiles = this.uploadedFiles.filter(f => f.id != fileId);
                const uploadedFiles = document.getElementById('uploadedFiles');
                uploadedFiles.innerHTML = '';
                this.uploadedFiles.forEach(file => this.displayUploadedFile(file));
                
                if (this.uploadedFiles.length === 0) {
                    this.toggleFileUpload();
                }
            }

            async checkAuthState() {
                if (firebaseInitialized) {
                    return new Promise((resolve) => {
                        auth.onAuthStateChanged(async (user) => {
                            if (user) {
                                this.currentUser = {
                                    uid: user.uid,
                                    name: user.displayName || 'مستخدم',
                                    email: user.email,
                                    avatar: user.photoURL,
                                    isOnline: true,
                                    lastSeen: new Date().toISOString()
                                };
                                
                                await this.updateUserPresence(true);
                                this.updateUserInterface();
                                document.getElementById('loginModal').style.display = 'none';
                            } else {
                                this.showLoginModal();
                            }
                            resolve();
                        });
                    });
                } else {
                    this.checkLocalAuth();
                }
            }

            checkLocalAuth() {
                const savedUser = localStorage.getItem('aijoo-user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.updateUserInterface();
                    document.getElementById('loginModal').style.display = 'none';
                } else {
                    this.showLoginModal();
                }
            }

            showLoginModal() {
                document.getElementById('loginModal').style.display = 'flex';
            }

            updateUserInterface() {
                if (this.currentUser) {
                    document.getElementById('userName').textContent = this.currentUser.name;
                    document.getElementById('userEmail').textContent = this.currentUser.email;
                    
                    const userAvatar = document.getElementById('userAvatar');
                    if (this.currentUser.avatar) {
                        userAvatar.innerHTML = `
                            <img src="${this.currentUser.avatar}" alt="Avatar">
                            <div class="user-status"></div>
                        `;
                    } else {
                        userAvatar.innerHTML = `
                            ${this.currentUser.name.charAt(0).toUpperCase()}
                            <div class="user-status"></div>
                        `;
                    }
                }
            }

            async updateUserPresence(isOnline) {
                if (firebaseInitialized && this.currentUser) {
                    try {
                        const userRef = realtimeDb.ref(`users/${this.currentUser.uid}`);
                        await userRef.set({
                            name: this.currentUser.name,
                            email: this.currentUser.email,
                            isOnline: isOnline,
                            lastSeen: firebase.database.ServerValue.TIMESTAMP
                        });
                    } catch (error) {
                        console.error('Error updating presence:', error);
                    }
                }
            }

            async loadChatHistory() {
                if (firebaseInitialized && this.currentUser) {
                    try {
                        const chatsRef = db.collection('users').doc(this.currentUser.uid).collection('chats');
                        const snapshot = await chatsRef.orderBy('lastUpdated', 'desc').limit(50).get();
                        
                        this.chatHistory = [];
                        snapshot.forEach(doc => {
                            this.chatHistory.push({ id: doc.id, ...doc.data() });
                        });
                    } catch (error) {
                        console.warn('Failed to load from Firestore:', error);
                        this.loadLocalChatHistory();
                    }
                } else {
                    this.loadLocalChatHistory();
                }
                
                this.updateChatHistoryUI();
            }

            loadLocalChatHistory() {
                const savedHistory = localStorage.getItem('aijoo-chat-history');
                if (savedHistory) {
                    this.chatHistory = JSON.parse(savedHistory);
                }
            }

            async saveChatHistory() {
                if (!this.currentChatId) return;

                const messages = this.getCurrentMessages();
                if (messages.length === 0) return;

                const chatData = {
                    id: this.currentChatId,
                    title: this.generateChatTitle(messages),
                    messages: messages,
                    lastUpdated: Date.now(),
                    messageCount: messages.length,
                    hasFiles: this.uploadedFiles.length > 0,
                    createdAt: this.chatHistory.find(c => c.id === this.currentChatId)?.createdAt || Date.now()
                };

                if (firebaseInitialized && this.currentUser) {
                    try {
                        const chatRef = db.collection('users').doc(this.currentUser.uid).collection('chats').doc(this.currentChatId);
                        await chatRef.set({
                            ...chatData,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    } catch (error) {
                        console.warn('Failed to save to Firestore:', error);
                        this.saveLocalChatHistory(chatData);
                    }
                } else {
                    this.saveLocalChatHistory(chatData);
                }
            }

            saveLocalChatHistory(chatData) {
                const existingChatIndex = this.chatHistory.findIndex(chat => chat.id === this.currentChatId);
                
                if (existingChatIndex >= 0) {
                    this.chatHistory[existingChatIndex] = chatData;
                } else {
                    this.chatHistory.unshift(chatData);
                }

                // Keep only last 100 chats
                if (this.chatHistory.length > 100) {
                    this.chatHistory = this.chatHistory.slice(0, 100);
                }

                localStorage.setItem('aijoo-chat-history', JSON.stringify(this.chatHistory));
                this.updateChatHistoryUI();
            }

            getCurrentMessages() {
                const messageElements = document.querySelectorAll('.message');
                const messages = [];
                
                messageElements.forEach(element => {
                    const isUser = element.classList.contains('user');
                    const content = element.querySelector('.message-bubble').innerHTML;
                    const timestamp = element.querySelector('.message-time')?.textContent || new Date().toLocaleTimeString('ar-SA');
                    
                    messages.push({
                        role: isUser ? 'user' : 'assistant',
                        content: content,
                        timestamp: timestamp,
                        id: Date.now() + Math.random()
                    });
                });
                
                return messages;
            }

            generateChatTitle(messages) {
                if (messages.length === 0) return 'محادثة جديدة';
                
                const firstUserMessage = messages.find(msg => msg.role === 'user');
                if (firstUserMessage) {
                    const textContent = firstUserMessage.content.replace(/<[^>]*>/g, '').trim();
                    return textContent.length > 60 ? textContent.substring(0, 60) + '...' : textContent;
                }
                
                return 'محادثة جديدة';
            }

            updateChatHistoryUI() {
                const chatHistory = document.getElementById('chatHistory');
                chatHistory.innerHTML = '';

                if (this.chatHistory.length === 0) {
                    chatHistory.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">
                            <i class="fas fa-comments" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <div>لا توجد محادثات سابقة</div>
                            <div style="font-size: 12px; margin-top: 4px; opacity: 0.7;">ابدأ محادثة جديدة الآن</div>
                        </div>
                    `;
                    return;
                }

                this.chatHistory.forEach(chat => {
                    const chatElement = document.createElement('div');
                    chatElement.className = `chat-item ${chat.id === this.currentChatId ? 'active' : ''}`;
                    
                    const timeAgo = this.getTimeAgo(chat.lastUpdated);
                    const hasFiles = chat.hasFiles ? '<i class="fas fa-paperclip" style="font-size: 10px; opacity: 0.6;"></i> ' : '';
                    
                    chatElement.innerHTML = `
                        <div class="chat-item-icon">
                            <i class="fas fa-${chat.hasFiles ? 'file-alt' : 'comment'}"></i>
                        </div>
                        <div class="chat-item-content">
                            <div class="chat-item-title">${chat.title}</div>
                            <div class="chat-item-preview">${hasFiles}${chat.messageCount} رسالة</div>
                            <div class="chat-item-time">${timeAgo}</div>
                        </div>
                        <div class="chat-item-actions">
                            <button class="chat-action-btn" onclick="aiJooChat.loadChat('${chat.id}')" title="فتح">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="chat-action-btn" onclick="aiJooChat.deleteChat('${chat.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    chatElement.addEventListener('click', (e) => {
                        if (!e.target.closest('.chat-action-btn')) {
                            this.loadChat(chat.id);
                        }
                    });
                    
                    chatHistory.appendChild(chatElement);
                });
            }

            getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'الآن';
                if (minutes < 60) return `${minutes} د`;
                if (hours < 24) return `${hours} س`;
                if (days < 7) return `${days} ي`;
                return new Date(timestamp).toLocaleDateString('ar-SA');
            }

            async loadChat(chatId) {
                const chat = this.chatHistory.find(c => c.id === chatId);
                if (!chat) return;

                this.showLoading('جاري تحميل المحادثة...');
                
                try {
                    this.currentChatId = chatId;
                    this.clearMessages();
                    
                    chat.messages.forEach(message => {
                        this.addMessage(message.content, message.role, false, message.timestamp);
                    });

                    this.updateChatHistoryUI();
                    document.getElementById('chatTitle').textContent = chat.title;
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('open');
                    }

                    this.hideLoading();
                    this.showNotification('تم التحميل', 'تم تحميل المحادثة بنجاح', 'success');
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('خطأ في التحميل', 'فشل في تحميل المحادثة', 'error');
                }
            }

            async deleteChat(chatId) {
                if (!confirm('هل أنت متأكد من حذف هذه المحادثة نهائياً؟')) return;

                this.showLoading('جاري الحذف...');

                try {
                    if (firebaseInitialized && this.currentUser) {
                        await db.collection('users').doc(this.currentUser.uid).collection('chats').doc(chatId).delete();
                    }

                    this.chatHistory = this.chatHistory.filter(chat => chat.id !== chatId);
                    localStorage.setItem('aijoo-chat-history', JSON.stringify(this.chatHistory));
                    
                    if (this.currentChatId === chatId) {
                        this.startNewChat();
                    }
                    
                    this.updateChatHistoryUI();
                    this.hideLoading();
                    this.showNotification('تم الحذف', 'تم حذف المحادثة بنجاح', 'success');
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('خطأ في الحذف', 'فشل في حذف المحادثة', 'error');
                }
            }

            async sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message && this.uploadedFiles.length === 0) return;

                // Create new chat if needed
                if (!this.currentChatId) {
                    this.currentChatId = Date.now().toString();
                    this.hideWelcomeScreen();
                }

                // Prepare message content
                let userMessage = message;
                let fileContext = '';
                
                if (this.uploadedFiles.length > 0) {
                    const fileList = this.uploadedFiles.map(f => f.name).join(', ');
                    fileContext = `\n\n📎 الملفات المرفقة: ${fileList}`;
                    userMessage += fileContext;
                    
                    // Add file content to context for AI
                    for (let file of this.uploadedFiles) {
                        if (file.type.startsWith('text/') || file.type.includes('json')) {
                            userMessage += `\n\nمحتوى الملف ${file.name}:\n${file.data}`;
                        }
                    }
                }

                // Add user message to UI
                this.addMessage(message + fileContext, 'user');
                chatInput.value = '';
                this.adjustTextareaHeight();
                this.clearUploadedFiles();

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    const response = await this.callGeminiAPI(userMessage);
                    this.hideTypingIndicator();
                    this.addMessage(response, 'assistant');
                    
                    // Speak response if synthesis is available
                    if (this.synthesis && this.shouldSpeakResponse()) {
                        this.speakText(response);
                    }
                    
                    // Save chat
                    await this.saveChatHistory();
                    
                    this.showNotification('تم الرد', 'تم استلام الرد بنجاح', 'success');
                } catch (error) {
                    this.hideTypingIndicator();
                    const errorMessage = this.getErrorMessage(error);
                    this.addMessage(errorMessage, 'assistant', true);
                    this.showNotification('خطأ في الاتصال', error.message, 'error');
                }
            }

            shouldSpeakResponse() {
                // Check if user prefers voice responses
                return localStorage.getItem('aijoo-voice-responses') === 'true';
            }

            speakText(text) {
                if (!this.synthesis) return;
                
                // Clean text for speech
                const cleanText = text.replace(/<[^>]*>/g, '').replace(/[*#`]/g, '');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                this.synthesis.speak(utterance);
            }

            getErrorMessage(error) {
                if (error.message.includes('API_KEY_INVALID')) {
                    return 'عذراً، مفتاح API غير صحيح. يرجى التحقق من الإعدادات.';
                } else if (error.message.includes('QUOTA_EXCEEDED')) {
                    return 'عذراً، تم تجاوز حد الاستخدام المسموح. يرجى المحاولة لاحقاً.';
                } else if (error.message.includes('403')) {
                    return 'عذراً، مفتاح API غير مفعل أو منتهي الصلاحية.';
                } else if (error.message.includes('429')) {
                    return 'عذراً، تم إرسال طلبات كثيرة. يرجى الانتظار قليلاً.';
                } else if (error.message.includes('500')) {
                    return 'عذراً، خطأ في الخادم. يرجى المحاولة مرة أخرى.';
                } else {
                    return 'عذراً، حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.';
                }
            }

            async callGeminiAPI(message) {
                const response = await fetch(`${this.apiUrl}?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `أنت Ai Joo، مساعد ذكي متقدم ومفيد جداً. يجب أن تكون دقيقاً ومفيداً ومبدعاً في إجاباتك. تحدث بالعربية بطريقة طبيعية ومفهومة. إذا كان هناك ملفات مرفقة، قم بتحليلها وتقديم معلومات مفيدة عنها.

الرسالة: ${message}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`خطأ في API: ${response.status} - ${errorData.error?.message || 'خطأ غير معروف'}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('لم يتم الحصول على رد من الذكاء الاصطناعي');
                }

                return data.candidates[0].content.parts[0].text;
            }

            addMessage(content, role, isError = false, timestamp = null) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${role} fade-in`;

                const currentTime = timestamp || new Date().toLocaleTimeString('ar-SA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const avatarIcon = role === 'user' ? 'fas fa-user' : 'fas fa-brain';
                const messageId = Date.now() + Math.random();

                messageElement.innerHTML = `
                    <div class="message-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ${isError ? 'error' : ''}">
                            ${this.formatMessage(content)}
                        </div>
                        <div class="message-time">${currentTime}</div>
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="aiJooChat.copyMessage(this)" title="نسخ">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="message-action-btn" onclick="aiJooChat.shareMessage(this)" title="مشاركة">
                                <i class="fas fa-share"></i>
                            </button>
                            ${role === 'assistant' ? `
                                <button class="message-action-btn" onclick="aiJooChat.speakMessage(this)" title="استماع">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <button class="message-action-btn" onclick="aiJooChat.regenerateResponse(this)" title="إعادة توليد">
                                    <i class="fas fa-redo"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                if (isError) {
                    messageElement.querySelector('.message-bubble').style.background = 'var(--danger)';
                    messageElement.querySelector('.message-bubble').style.color = 'white';
                }

                chatMessages.appendChild(messageElement);
                this.scrollToBottom();
                
                // Update chat title if this is the first message
                if (role === 'user' && !document.getElementById('chatTitle').textContent.includes('محادثة')) {
                    const title = content.length > 30 ? content.substring(0, 30) + '...' : content;
                    document.getElementById('chatTitle').textContent = title;
                }
            }

            formatMessage(content) {
                // Enhanced message formatting with better markdown support
                let formatted = content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em;">$1</code>');

                // Format code blocks with syntax highlighting
                formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    const language = lang || 'text';
                    return `
                        <div class="code-block">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="color: #888; font-size: 12px;">${language}</span>
                                <button class="copy-code-btn" onclick="aiJooChat.copyCode(this)">
                                    <i class="fas fa-copy"></i> نسخ
                                </button>
                            </div>
                            <pre><code>${code.trim()}</code></pre>
                        </div>
                    `;
                });

                // Format URLs
                formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary); text-decoration: underline;">$1</a>');

                // Format lists
                formatted = formatted.replace(/^\d+\.\s(.+)$/gm, '<div style="margin: 4px 0;">$1</div>');
                formatted = formatted.replace(/^[-*]\s(.+)$/gm, '<div style="margin: 4px 0;">• $1</div>');

                return formatted;
            }

            hideWelcomeScreen() {
                const welcomeScreen = document.querySelector('.welcome-screen');
                if (welcomeScreen) {
                    welcomeScreen.style.display = 'none';
                }
            }

            showWelcomeScreen() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="welcome-screen">
                        <div class="welcome-logo bounce-in">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h2 class="welcome-title">مرحباً بك في <span style="color: var(--primary);">Ai</span> <span style="color: var(--secondary);">Joo</span></h2>
                        <p class="welcome-subtitle">منصة الذكاء الاصطناعي المتكاملة مع مكالمات صوتية ورفع ملفات ومميزات متقدمة. ابدأ محادثتك الآن!</p>
                        
                        <div class="welcome-features">
                            <div class="feature-card" onclick="sendSuggestion('اشرح لي مفهوم الذكاء الاصطناعي والتعلم الآلي بطريقة مبسطة')">
                                <div class="feature-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="feature-title">الذكاء الاصطناعي</div>
                                <div class="feature-description">تعلم واكتشف عالم الذكاء الاصطناعي والتعلم الآلي</div>
                            </div>
                            
                            <div class="feature-card" onclick="sendSuggestion('اكتب لي مقال احترافي عن أهمية التكنولوجيا في التعليم')">
                                <div class="feature-icon">
                                    <i class="fas fa-pen-fancy"></i>
                                </div>
                                <div class="feature-title">الكتابة الإبداعية</div>
                                <div class="feature-description">مساعدة في الكتابة والتحرير والإبداع الأدبي</div>
                            </div>
                            
                            <div class="feature-card" onclick="sendSuggestion('ساعدني في حل مسائل رياضية معقدة خطوة بخطوة')">
                                <div class="feature-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="feature-title">حل المسائل</div>
                                <div class="feature-description">مساعدة في الرياضيات والعلوم والمنطق</div>
                            </div>
                            
                            <div class="feature-card" onclick="sendSuggestion('اكتب لي كود برمجي متقدم بلغة Python مع الشرح')">
                                <div class="feature-icon">
                                    <i class="fas fa-code"></i>
                                </div>
                                <div class="feature-title">البرمجة المتقدمة</div>
                                <div class="feature-description">مساعدة في كتابة وتطوير الكود البرمجي</div>
                            </div>
                            
                            <div class="feature-card" onclick="startVoiceCall()">
                                <div class="feature-icon">
                                    <i class="fas fa-phone"></i>
                                </div>
                                <div class="feature-title">مكالمة صوتية</div>
                                <div class="feature-description">تحدث مع Ai Joo بالصوت مباشرة</div>
                            </div>
                            
                            <div class="feature-card" onclick="toggleFileUpload()">
                                <div class="feature-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="feature-title">رفع الملفات</div>
                                <div class="feature-description">ارفع الصور والمستندات للتحليل</div>
                            </div>
                        </div>

                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="sendSuggestion('ما الجديد في عالم التكنولوجيا؟')">
                                أخبار التكنولوجيا
                            </button>
                            <button class="quick-action-btn" onclick="sendSuggestion('اعطني نصائح لتحسين الإنتاجية')">
                                نصائح الإنتاجية
                            </button>
                            <button class="quick-action-btn" onclick="sendSuggestion('اكتب لي قصة قصيرة مشوقة')">
                                قصة إبداعية
                            </button>
                            <button class="quick-action-btn" onclick="sendSuggestion('ساعدني في تعلم لغة جديدة')">
                                تعلم اللغات
                            </button>
                        </div>
                    </div>
                `;
            }

            clearMessages() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
            }

            clearUploadedFiles() {
                this.uploadedFiles = [];
                document.getElementById('uploadedFiles').innerHTML = '';
                const fileUploadArea = document.getElementById('fileUploadArea');
                if (fileUploadArea.classList.contains('show')) {
                    fileUploadArea.classList.remove('show');
                }
            }

            showTypingIndicator() {
                document.getElementById('typingIndicator').classList.add('show');
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').classList.remove('show');
            }

            scrollToBottom() {
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            startNewChat() {
                this.currentChatId = null;
                this.clearMessages();
                this.showWelcomeScreen();
                this.clearUploadedFiles();
                document.getElementById('chatTitle').textContent = 'Ai Joo';
                this.updateChatHistoryUI();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }

            loadTheme() {
                const savedTheme = localStorage.getItem('aijoo-theme');
                if (savedTheme === 'dark') {
                    this.darkTheme = true;
                    document.body.classList.add('dark-theme');
                    document.getElementById('themeIcon').className = 'fas fa-sun';
                    document.getElementById('themeMenuIcon').className = 'fas fa-sun';
                    document.getElementById('themeMenuText').textContent = 'الوضع الفاتح';
                }
            }

            toggleTheme() {
                this.darkTheme = !this.darkTheme;
                document.body.classList.toggle('dark-theme');
                
                const themeIcon = document.getElementById('themeIcon');
                const themeMenuIcon = document.getElementById('themeMenuIcon');
                const themeMenuText = document.getElementById('themeMenuText');
                
                if (this.darkTheme) {
                    themeIcon.className = 'fas fa-sun';
                    themeMenuIcon.className = 'fas fa-sun';
                    themeMenuText.textContent = 'الوضع الفاتح';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeMenuIcon.className = 'fas fa-moon';
                    themeMenuText.textContent = 'الوضع المظلم';
                }
                
                localStorage.setItem('aijoo-theme', this.darkTheme ? 'dark' : 'light');
                this.showNotification('تم التغيير', `تم التبديل إلى المظهر ${this.darkTheme ? 'المظلم' : 'الفاتح'}`, 'success');
            }

            // Voice Call Functions
            async startVoiceCall() {
                if (this.isInCall) {
                    this.showNotification('مكالمة نشطة', 'لديك مكالمة نشطة بالفعل', 'warning');
                    return;
                }

                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.isInCall = true;
                    this.callStartTime = Date.now();
                    
                    document.getElementById('voiceCallOverlay').classList.add('show');
                    document.getElementById('callStatus').textContent = 'مكالمة صوتية نشطة';
                    
                    this.startCallTimer();
                    this.showNotification('بدء المكالمة', 'تم بدء المكالمة الصوتية', 'success');
                    
                    // Simulate AI voice response
                    setTimeout(() => {
                        this.speakText('مرحباً! أنا Ai Joo، مساعدك الذكي. كيف يمكنني مساعدتك اليوم؟');
                    }, 2000);
                    
                } catch (error) {
                    this.showNotification('خطأ في المكالمة', 'فشل في الوصول للميكروفون', 'error');
                }
            }

            startCallTimer() {
                this.callTimer = setInterval(() => {
                    if (this.isInCall) {
                        this.callDuration = Math.floor((Date.now() - this.callStartTime) / 1000);
                        const minutes = Math.floor(this.callDuration / 60);
                        const seconds = this.callDuration % 60;
                        document.getElementById('callDuration').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }

            toggleMute() {
                const muteBtn = document.getElementById('muteBtn');
                const isMuted = muteBtn.classList.contains('active');
                
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = isMuted;
                    });
                }
                
                muteBtn.classList.toggle('active');
                muteBtn.innerHTML = isMuted ? 
                    '<i class="fas fa-microphone"></i>' : 
                    '<i class="fas fa-microphone-slash"></i>';
                
                this.showNotification(
                    isMuted ? 'تم إلغاء الكتم' : 'تم كتم الصوت', 
                    isMuted ? 'تم تشغيل الميكروفون' : 'تم إيقاف الميكروفون', 
                    'info'
                );
            }

            endCall() {
                if (!this.isInCall) return;
                
                this.isInCall = false;
                
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                if (this.callTimer) {
                    clearInterval(this.callTimer);
                    this.callTimer = null;
                }
                
                document.getElementById('voiceCallOverlay').classList.remove('show');
                
                const duration = Math.floor(this.callDuration / 60);
                this.showNotification('انتهت المكالمة', `مدة المكالمة: ${duration} دقيقة`, 'info');
                
                this.callDuration = 0;
            }

            // Voice Input Functions
            toggleVoiceInput() {
                if (!this.recognition) {
                    this.showNotification('غير مدعوم', 'التعرف على الصوت غير مدعوم في هذا المتصفح', 'warning');
                    return;
                }

                const voiceBtn = document.getElementById('voiceInputBtn');
                
                if (!this.isRecording) {
                    this.recognition.start();
                    this.isRecording = true;
                    voiceBtn.classList.add('recording');
                } else {
                    this.stopVoiceInput();
                }
            }

            stopVoiceInput() {
                if (this.recognition) {
                    this.recognition.stop();
                }
                this.isRecording = false;
                const voiceBtn = document.getElementById('voiceInputBtn');
                voiceBtn.classList.remove('recording');
            }

            // File Upload Functions
            toggleFileUpload() {
                const fileUploadArea = document.getElementById('fileUploadArea');
                fileUploadArea.classList.toggle('show');
                
                if (!fileUploadArea.classList.contains('show')) {
                    this.clearUploadedFiles();
                }
            }

            // Message Actions
            copyMessage(btn) {
                const messageContent = btn.closest('.message').querySelector('.message-bubble').textContent;
                navigator.clipboard.writeText(messageContent).then(() => {
                    this.showNotification('تم النسخ', 'تم نسخ الرسالة بنجاح', 'success');
                }).catch(() => {
                    this.showNotification('خطأ في النسخ', 'فشل في نسخ الرسالة', 'error');
                });
            }

            shareMessage(btn) {
                const messageContent = btn.closest('.message').querySelector('.message-bubble').textContent;
                if (navigator.share) {
                    navigator.share({
                        title: 'رسالة من Ai Joo',
                        text: messageContent
                    });
                } else {
                    this.copyMessage(btn);
                }
            }

            speakMessage(btn) {
                const messageContent = btn.closest('.message').querySelector('.message-bubble').textContent;
                this.speakText(messageContent);
            }

            copyCode(btn) {
                const codeContent = btn.parentElement.nextElementSibling.textContent;
                navigator.clipboard.writeText(codeContent).then(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-copy"></i> نسخ';
                    }, 2000);
                });
            }

            async regenerateResponse(btn) {
                const messageElement = btn.closest('.message');
                const previousMessages = [];
                
                // Get all messages before this one
                const allMessages = document.querySelectorAll('.message');
                for (let msg of allMessages) {
                    if (msg === messageElement) break;
                    const isUser = msg.classList.contains('user');
                    const content = msg.querySelector('.message-bubble').textContent;
                    previousMessages.push({ role: isUser ? 'user' : 'assistant', content });
                }

                // Get the last user message
                const lastUserMessage = previousMessages.filter(m => m.role === 'user').pop();
                if (!lastUserMessage) return;

                // Remove the current assistant message
                messageElement.remove();

                // Show typing indicator and regenerate
                this.showTypingIndicator();
                
                try {
                    const response = await this.callGeminiAPI(lastUserMessage.content);
                    this.hideTypingIndicator();
                    this.addMessage(response, 'assistant');
                    await this.saveChatHistory();
                    this.showNotification('تم التجديد', 'تم إعادة توليد الرد', 'success');
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('عذراً، حدث خطأ في إعادة التوليد.', 'assistant', true);
                    this.showNotification('خطأ في التجديد', 'فشل في إعادة توليد الرد', 'error');
                }
            }

            // Utility Functions
            insertEmoji() {
                const emojis = ['😊', '😂', '🤔', '👍', '❤️', '🔥', '✨', '🎉', '💡', '🚀', '💯', '🎯', '⭐', '🌟', '💪', '🧠', '📚', '🎨', '🎵', '🌈'];
                const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                const chatInput = document.getElementById('chatInput');
                const cursorPos = chatInput.selectionStart;
                const textBefore = chatInput.value.substring(0, cursorPos);
                const textAfter = chatInput.value.substring(cursorPos);
                
                chatInput.value = textBefore + randomEmoji + textAfter;
                chatInput.focus();
                chatInput.setSelectionRange(cursorPos + randomEmoji.length, cursorPos + randomEmoji.length);
                this.adjustTextareaHeight();
            }

            exportChat() {
                const messages = document.querySelectorAll('.message');
                if (messages.length === 0) {
                    this.showNotification('لا توجد رسائل', 'لا توجد رسائل للتصدير', 'warning');
                    return;
                }

                let chatText = `محادثة Ai Joo - ${new Date().toLocaleDateString('ar-SA')}\n`;
                chatText += `المطور: المهندس يوسف خالد\n`;
                chatText += `المستخدم: ${this.currentUser?.name || 'ضيف'}\n`;
                chatText += `عدد الرسائل: ${messages.length}\n`;
                chatText += `تاريخ التصدير: ${new Date().toLocaleString('ar-SA')}\n\n`;
                chatText += '='.repeat(60) + '\n\n';

                messages.forEach((message, index) => {
                    const sender = message.classList.contains('user') ? 'أنت' : 'Ai Joo';
                    const content = message.querySelector('.message-bubble').textContent;
                    const time = message.querySelector('.message-time').textContent;
                    chatText += `[${index + 1}] ${sender} (${time}):\n${content}\n\n`;
                });

                chatText += '='.repeat(60) + '\n';
                chatText += 'تم التصدير بواسطة Ai Joo - منصة الذكاء الاصطناعي المتكاملة\n';
                chatText += 'المطور: المهندس يوسف خالد';

                const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AiJoo_Chat_${new Date().toISOString().split('T')[0]}_${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showNotification('تم التصدير', 'تم تصدير المحادثة بنجاح!', 'success');
            }

            clearCurrentChat() {
                if (!confirm('هل أنت متأكد من مسح المحادثة الحالية؟ سيتم حفظها في السجل.')) return;
                
                if (this.currentChatId) {
                    this.saveChatHistory();
                }
                
                this.startNewChat();
                this.showNotification('تم المسح', 'تم مسح المحادثة وحفظها في السجل', 'success');
            }

            // User Interface Functions
            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('open');
            }

            toggleUserMenu() {
                document.getElementById('userMenu').classList.toggle('show');
            }

            showProfile() {
                this.showNotification('الملف الشخصي', 'صفحة الملف الشخصي قريباً!', 'info');
                document.getElementById('userMenu').classList.remove('show');
            }

            showSettings() {
                this.showNotification('الإعدادات', 'صفحة الإعدادات المتقدمة قريباً!', 'info');
                document.getElementById('userMenu').classList.remove('show');
            }

            // Notification System
            showNotification(title, message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationTitle = document.getElementById('notificationTitle');
                const notificationMessage = document.getElementById('notificationMessage');
                const notificationIcon = notification.querySelector('.notification-icon i');

                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                // Reset classes
                notification.className = `notification ${type}`;
                
                // Set appropriate icon
                switch (type) {
                    case 'success':
                        notificationIcon.className = 'fas fa-check-circle';
                        break;
                    case 'error':
                        notificationIcon.className = 'fas fa-exclamation-circle';
                        break;
                    case 'warning':
                        notificationIcon.className = 'fas fa-exclamation-triangle';
                        break;
                    case 'info':
                        notificationIcon.className = 'fas fa-info-circle';
                        break;
                }

                notification.classList.add('show');

                // Auto hide after 5 seconds
                setTimeout(() => {
                    this.hideNotification();
                }, 5000);
            }

            hideNotification() {
                document.getElementById('notification').classList.remove('show');
            }

            // Loading System
            showLoading(text = 'جاري التحميل...') {
                document.getElementById('loadingText').textContent = text;
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            // Utility Functions
            updateTypingStatus() {
                // Update typing status for real-time collaboration
                if (firebaseInitialized && this.currentUser && this.currentChatId) {
                    const typingRef = realtimeDb.ref(`typing/${this.currentChatId}/${this.currentUser.uid}`);
                    typingRef.set(true);
                    
                    // Remove typing status after 3 seconds
                    setTimeout(() => {
                        typingRef.remove();
                    }, 3000);
                }
            }

            handleResize() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('open');
                }
            }

            closeAllModals() {
                document.getElementById('userMenu').classList.remove('show');
                const fileUploadArea = document.getElementById('fileUploadArea');
                if (fileUploadArea.classList.contains('show')) {
                    fileUploadArea.classList.remove('show');
                }
            }

            startPeriodicSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                    if (this.currentChatId) {
                        this.saveChatHistory();
                    }
                }, 30000);
            }

            async syncOfflineData() {
                // Sync offline data when connection is restored
                if (firebaseInitialized && this.currentUser) {
                    try {
                        const offlineData = localStorage.getItem('aijoo-offline-data');
                        if (offlineData) {
                            const data = JSON.parse(offlineData);
                            // Sync offline chats to Firebase
                            for (let chat of data.chats || []) {
                                const chatRef = db.collection('users').doc(this.currentUser.uid).collection('chats').doc(chat.id);
                                await chatRef.set(chat, { merge: true });
                            }
                            localStorage.removeItem('aijoo-offline-data');
                            this.showNotification('تم المزامنة', 'تم مزامنة البيانات المحلية', 'success');
                        }
                    } catch (error) {
                        console.error('Error syncing offline data:', error);
                    }
                }
            }

            async signOut() {
                if (!confirm('هل أنت متأكد من تسجيل الخروج؟')) return;
                
                this.showLoading('جاري تسجيل الخروج...');
                
                try {
                    // Save current chat before signing out
                    if (this.currentChatId) {
                        await this.saveChatHistory();
                    }
                    
                    // Update presence to offline
                    await this.updateUserPresence(false);
                    
                    // Sign out from Firebase
                    if (firebaseInitialized) {
                        await auth.signOut();
                    }
                    
                    // Clear local data
                    localStorage.removeItem('aijoo-user');
                    this.currentUser = null;
                    
                    // Reset UI
                    this.startNewChat();
                    document.getElementById('userMenu').classList.remove('show');
                    this.showLoginModal();
                    
                    this.hideLoading();
                    this.showNotification('تم تسجيل الخروج', 'تم تسجيل الخروج بنجاح', 'success');
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('خطأ في تسجيل الخروج', 'فشل في تسجيل الخروج', 'error');
                }
            }
        }

        // Global functions
        function toggleSidebar() {
            aiJooChat.toggleSidebar();
        }

        function startNewChat() {
            aiJooChat.startNewChat();
        }

        function toggleTheme() {
            aiJooChat.toggleTheme();
        }

        function exportChat() {
            aiJooChat.exportChat();
        }

        function clearCurrentChat() {
            aiJooChat.clearCurrentChat();
        }

        function showSettings() {
            aiJooChat.showSettings();
        }

        function toggleUserMenu() {
            aiJooChat.toggleUserMenu();
        }

        function showProfile() {
            aiJooChat.showProfile();
        }

        function signOut() {
            aiJooChat.signOut();
        }

        function sendSuggestion(message) {
            document.getElementById('chatInput').value = message;
            aiJooChat.sendMessage();
        }

        function toggleFileUpload() {
            aiJooChat.toggleFileUpload();
        }

        function toggleVoiceInput() {
            aiJooChat.toggleVoiceInput();
        }

        function insertEmoji() {
            aiJooChat.insertEmoji();
        }

        function startVoiceCall() {
            aiJooChat.startVoiceCall();
        }

        function toggleMute() {
            aiJooChat.toggleMute();
        }

        function endCall() {
            aiJooChat.endCall();
        }

        function hideNotification() {
            aiJooChat.hideNotification();
        }

        function sendMessage() {
            aiJooChat.sendMessage();
        }

        async function signInWithGoogle() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = 'جاري تسجيل الدخول...';
            
            if (firebaseInitialized) {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    // Save user data
                    const userData = {
                        uid: user.uid,
                        name: user.displayName,
                        email: user.email,
                        avatar: user.photoURL,
                        signInTime: new Date().toISOString()
                    };
                    
                    localStorage.setItem('aijoo-user', JSON.stringify(userData));
                    
                    document.getElementById('loadingOverlay').style.display = 'none';
                    aiJooChat.showNotification('مرحباً بك', `أهلاً وسهلاً ${user.displayName}!`, 'success');
                } catch (error) {
                    console.error('Google sign-in error:', error);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        aiJooChat.showNotification('تم الإلغاء', 'تم إلغاء تسجيل الدخول', 'info');
                    } else {
                        // Fallback to mock login
                        mockGoogleLogin();
                    }
                }
            } else {
                // Mock Google login for demo
                mockGoogleLogin();
            }
        }

        function mockGoogleLogin() {
            setTimeout(() => {
                const mockUser = {
                    uid: 'demo_user_' + Date.now(),
                    name: 'مستخدم تجريبي',
                    email: 'demo@aijoo.com',
                    avatar: null,
                    signInTime: new Date().toISOString()
                };
                
                aiJooChat.currentUser = mockUser;
                localStorage.setItem('aijoo-user', JSON.stringify(mockUser));
                aiJooChat.updateUserInterface();
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'none';
                aiJooChat.showNotification('مرحباً بك', 'تم تسجيل الدخول التجريبي بنجاح!', 'success');
            }, 1500);
        }

        function skipLogin() {
            const guestUser = {
                uid: 'guest_' + Date.now(),
                name: 'مستخدم ضيف',
                email: 'guest@aijoo.com',
                avatar: null,
                signInTime: new Date().toISOString()
            };
            
            aiJooChat.currentUser = guestUser;
            localStorage.setItem('aijoo-user', JSON.stringify(guestUser));
            aiJooChat.updateUserInterface();
            document.getElementById('loginModal').style.display = 'none';
            aiJooChat.showNotification('مرحباً بك', 'يمكنك استخدام Ai Joo كضيف', 'info');
        }

        // Initialize the app
        let aiJooChat;
        document.addEventListener('DOMContentLoaded', () => {
            aiJooChat = new AiJooAdvancedChat();
        });

        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    console.log('Service Worker غير متاح');
                });
            });
        }

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log(`⚡ تم تحميل Ai Joo في ${Math.round(perfData.loadEventEnd - perfData.fetchStart)}ms`);
                }, 0);
            });
        }

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('خطأ في التطبيق:', e.error);
            if (aiJooChat) {
                aiJooChat.showNotification('خطأ في التطبيق', 'حدث خطأ غير متوقع', 'error');
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('خطأ في Promise:', e.reason);
            if (aiJooChat) {
                aiJooChat.showNotification('خطأ في العملية', 'فشل في تنفيذ العملية', 'error');
            }
        });

        // Console welcome message
        console.log(`
🚀 مرحباً بك في Ai Joo - منصة الذكاء الاصطناعي المتكاملة
💡 المطور: المهندس يوسف خالد
⚡ الإصدار: 3.0 Pro
🔥 المميزات: مكالمات صوتية، رفع ملفات، Firebase، WebRTC

📋 الاختصارات المفيدة:
   Ctrl+K: التركيز على مربع الرسائل
   Ctrl+N: محادثة جديدة
   Ctrl+/: تبديل المظهر
   Ctrl+E: تصدير المحادثة
   Escape: إغلاق النوافذ المنبثقة

🌟 استمتع بتجربة الذكاء الاصطناعي المتطورة!
        `);
    </script>
</body>
</html>
